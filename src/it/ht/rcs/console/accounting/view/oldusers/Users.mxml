<?xml version="1.0" encoding="utf-8"?>
<s:HGroup xmlns:fx="http://ns.adobe.com/mxml/2009"
          xmlns:s="library://ns.adobe.com/flex/spark"
          xmlns:mx="library://ns.adobe.com/flex/mx"
          left="10" right="10" top="0" bottom="10" addedToStage="added()" creationComplete="init()">
  
  <fx:Script>
    <![CDATA[
      import it.ht.rcs.console.accounting.controller.SessionManager;
      import it.ht.rcs.console.accounting.controller.UserManager;
      import it.ht.rcs.console.accounting.model.User;
      import it.ht.rcs.console.events.EditEvent;
      import it.ht.rcs.console.utils.AlertPopUp;
      import it.ht.rcs.console.utils.TimeUtils;
      
      import locale.R;
      
      import mx.collections.ListCollectionView;
      import mx.events.CloseEvent;
      import mx.managers.PopUpManager;
      
      import spark.components.gridClasses.GridColumn;
      
      [Bindable]
      private var _users_view:ListCollectionView;
      [Bindable]
      private var _conn_users_view:ListCollectionView;
      
      private function init():void
      {
        /* this event is fired by the itemrenderer in the user list (when editing, doubleclick) */
        addEventListener(EditEvent.USER, onEditUser);
      }
      
      private function added():void
      {
        /* get the view on users list */
        _conn_users_view = SessionManager.instance.getView();
        _users_view = UserManager.instance.getView();
      }
      
      private function formatdate(item:Object, column:GridColumn):String
      {
        return TimeUtils.timestampFormatter(item[column.dataField] * 1000);
      }
      
      private function deleteUser(user:User):void
      {
        if (user == null)
          return;
        
        AlertPopUp.show(R.get('CONFIRM_USER_DELETION', [user.name]), R.get('CONFIRM'), AlertPopUp.YES|AlertPopUp.NO, null,
          function(e:CloseEvent):void {
            if (e.detail == AlertPopUp.YES) 
              UserManager.instance.removeItem(user);
          }, null, AlertPopUp.NO);
      }
      
      private function addUser():void
      {
        /* create the new user */
        UserManager.instance.newUser(function onSuccess(u:User):void {
          selectUser(u);
          editUser(u);
        });
      }
      
      private function selectUser(u:User):void
      {
//        var index:Vector.<int> = new Vector.<int>(1);
//        index[0] = _users_view.getItemIndex(u);
//        userslist.selectedIndices = index;
        userslist.selectedItem = u;
      }
      
      private function onEditUser(e:EditEvent):void
      {
        editUser(e.user);
      }
      
      private function editUser(u:User):void
      {
        var eu:UserEdit = PopUpManager.createPopUp(root, UserEdit, true) as UserEdit;
        eu.user = u;
        /* keep the user selected even if it changes position (due to alphabetical sorting) */
        eu.callback = function select():void {
          selectUser(u);
        };
        PopUpManager.centerPopUp(eu);
      }
    ]]>
  </fx:Script>
  
  <fx:Metadata>
    [ResourceBundle("localized_main")] 
  </fx:Metadata>
  
  <!-- USERS -->
  <s:SkinnableContainer width="100%" height="100%">
    <s:Label top="5" horizontalCenter="0" paddingRight="0" styleName="AccountingTitles"
             text="{resourceManager.getString('localized_main', 'USERS')}"/>
    <s:BorderContainer id="userlistshadow" left="0" right="0" top="30" bottom="0"
                       backgroundColor="#EAEAEA" borderVisible="true" dropShadowVisible="true">
      <s:List id="userslist" left="5" right="5" top="5" bottom="20" borderVisible="false"
              contentBackgroundColor="#EAEAEA" dataProvider="{_users_view}"
              itemRenderer="it.ht.rcs.console.accounting.view.oldusers.UserRenderer">
        <s:layout>
          <s:TileLayout horizontalGap="10" verticalGap="10"/>
        </s:layout>
      </s:List>
      <!-- the current user cannot delete himself -->
      <s:Button right="33" bottom="1" width="32" height="20" label="-"
                click="deleteUser(userslist.selectedItem as User)"
                enabled="{userslist.selectedItem != null &amp;&amp; (userslist.selectedItem as User)._id != Console.currentSession.user._id}"
                styleName="AddRemove"
                toolTip="{resourceManager.getString('localized_main', 'USER_DELETE')}"/>
      <s:Button right="1" bottom="1" width="32" height="20" label="+" click="addUser()"
                styleName="AddRemove"
                toolTip="{resourceManager.getString('localized_main', 'USER_ADD')}"/>
    </s:BorderContainer>
  </s:SkinnableContainer>
  
  <!-- CONNECTED USERS -->
  <s:SkinnableContainer width="100%" height="100%">
    <s:Label top="5" horizontalCenter="0" styleName="AccountingTitles"
             text="{resourceManager.getString('localized_main', 'USERS_CONNECTED')}"/>
    <s:BorderContainer id="activeuserlistshadow" left="0" right="0" top="30" bottom="0"
                       borderVisible="false" dropShadowVisible="true">

      <s:DataGrid id="activeusersgrid" left="0" right="0" top="0" bottom="0"
                  dataProvider="{_conn_users_view}" editable="false">
        <s:columns>
          <s:ArrayList>
            <s:GridColumn minWidth="200" dataField="user.name"
                          headerText="{resourceManager.getString('localized_main', 'USER')}"/>
            <s:GridColumn width="85" dataField="level"
                          headerText="{resourceManager.getString('localized_main', 'PRIVILEGES')}"
                          itemRenderer="it.ht.rcs.console.accounting.view.oldusers.PrivsRenderer"
                          resizable="false"/>
            <s:GridColumn dataField="address"
                          headerText="{resourceManager.getString('localized_main', 'ADDRESS')}"/>
            <s:GridColumn width="130" dataField="time"
                          headerText="{resourceManager.getString('localized_main', 'LOGON_TIME')}"
                          labelFunction="formatdate" resizable="false"/>
            <s:GridColumn width="35" headerText="" resizable="false" sortable="false">
              <s:itemRenderer>
                <fx:Component>
                  <s:GridItemRenderer>
                    <fx:Script>
                      <![CDATA[
                        import it.ht.rcs.console.accounting.controller.SessionManager;
                        import it.ht.rcs.console.accounting.controller.UserManager;
                      ]]>
                    </fx:Script>
                    <s:SkinnableContainer width="100%" height="100%">
                      <s:Button left="5" top="5" width="15" height="15"
                                click="{SessionManager.instance.disconnectUser(data)}"
                                horizontalCenter="0"
                                skinClass="spark.skins.spark.TitleWindowCloseButtonSkin"
                                toolTip="{resourceManager.getString('localized_main', 'DISCONNECT_USER')}"/>                                                
                    </s:SkinnableContainer>
                  </s:GridItemRenderer>
                </fx:Component>
              </s:itemRenderer>
            </s:GridColumn>
          </s:ArrayList>
        </s:columns>
      </s:DataGrid>
    </s:BorderContainer>
  </s:SkinnableContainer>
  
</s:HGroup>
