<?xml version="1.0" encoding="utf-8"?>
<s:Panel xmlns:fx="http://ns.adobe.com/mxml/2009"
         xmlns:s="library://ns.adobe.com/flex/spark"
         xmlns:mx="library://ns.adobe.com/flex/mx"
         xmlns:main="it.ht.rcs.console.operations.main.*"
         xmlns:breadcrumbs="it.ht.rcs.console.operations.main.breadcrumbs.*"
         addedToStage="onAddedToStage(event)" creationComplete="init()"
         removedFromStage="onRemovedFromStage(event)" title="OPERATIONS">

  <s:states>
    <s:State name="default"/>
    
    <s:State name="allOperations"/>
    <s:State name="singleOperation"/>
    
    <s:State name="allTargets"/>
    <s:State name="singleTarget"/>
    
    <s:State name="allAgents"/>
    <s:State name="singleAgent"/>
  </s:states>
  
  <s:layout>
    <s:VerticalLayout gap="5" paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5"/>
  </s:layout>
  
  <fx:Script>
    <![CDATA[
      import it.ht.rcs.console.agent.controller.AgentManager;
      import it.ht.rcs.console.events.SectionEvent;
      import it.ht.rcs.console.events.SessionEvent;
      import it.ht.rcs.console.operation.controller.OperationManager;
      import it.ht.rcs.console.operations.main.StateManager;
      import it.ht.rcs.console.target.controller.TargetManager;
      
      import mx.core.FlexGlobals;
      
      [Bindable]
      public var stateManager:StateManager;
      
      private var itemToSelect:Object = null;
      private function init():void
      {
        stateManager = new StateManager(this);
        FlexGlobals.topLevelApplication.addEventListener(SessionEvent.LOGGING_OUT, onLoggingOut);
        if (itemToSelect)
          stateManager.manageItemSelection(itemToSelect);
        else
          stateManager.setState('allOperations');
      }
      
      private function onAddedToStage(event:Event):void
      {
        if (stateManager)
          stateManager.setState(currentState);
      }
      
      private function onRemovedFromStage(event:Event):void
      {
        if (stateManager)
          stateManager.stopManagers();
      }
      
      private function onLoggingOut(event:SessionEvent):void
      {
        stateManager.resetState();
      }
      
      public function changeSection(event:SectionEvent):void
      {
        if (event.item == null) { return };
        
        var item:* = null;
        switch (event.item._kind) {
          case 'operation':
            item = OperationManager.instance.getItem(event.item._id);
            break;
          case 'target':
            item = TargetManager.instance.getItem(event.item._id);
            break;
          case 'agent':
            item = AgentManager.instance.getItem(event.item._id);
            break;
          default:
            break;
        }
        
        if (item) {
          if (stateManager)
            stateManager.manageItemSelection(item);
          else
            itemToSelect = item;
        }
      }
    ]]>
  </fx:Script>
  
  
  <breadcrumbs:OperationBreadcrumbs/>
  
  <main:OperationButtonBar id="buttonBar" currentState="{currentState}" section="{this}"/>
  
  <main:OperationBody id="body"/>
  
</s:Panel>