<?xml version="1.0" encoding="utf-8"?>
<s:VGroup xmlns:fx="http://ns.adobe.com/mxml/2009"
          xmlns:s="library://ns.adobe.com/flex/spark"
          xmlns:mx="library://ns.adobe.com/flex/mx"
          xmlns:filesystem="it.ht.rcs.console.operations.view.filesystem.*"
          width="100%" height="100%" removedFromStage="onRemovedFromStage()">

  <fx:Script>
    <![CDATA[
      import it.ht.rcs.console.agent.model.Agent;
      import it.ht.rcs.console.evidence.controller.EvidenceManager;
      import it.ht.rcs.console.evidence.model.Evidence;
      import it.ht.rcs.console.operations.view.OperationsSection;
      import it.ht.rcs.console.utils.Size;
      import it.ht.rcs.console.utils.TimeUtils;
      
      import mx.collections.HierarchicalData;
      import mx.rpc.events.ResultEvent;
      import mx.utils.ObjectUtil;
      
      [Bindable]
      public var section:OperationsSection;
      
      public function showTree():void
      {
        var agent:Agent = section.stateManager.selectedAgent;
        EvidenceManager.instance.filesystem(section.stateManager.selectedTarget._id, agent ? agent._id : null, onResult);
      }
      
      private function onResult(event:ResultEvent):void
      {
        var root:Object = { name: 'root', children: [], size: -1, attr: -1, date: -1, parent: null };
        
        for each (var e:Evidence in event.result) {
          var path:String = e.data.path;
          path = path.replace('\\\\', '\\');
          var separator:String = path.indexOf('/') == -1 ? '\\' : '/';
          var tokens:Array = path.split(separator);
          var node:Object = root;
          for each (var t:String in tokens) {
            if (t == '') continue;
            var next:Object = getChild(node.children, t);
            if (!next) {
              next = { name: t, children: [], size: e.data.size, attr: e.data.attr, date: e.da, parent: node, evidence: e };
              if (e.data.attr == 0)
                delete(next.children);
              node.children.push(next);
              node = next;
            }
            else
              node = next;
          }
        }
        trace(ObjectUtil.toString(root));
        grid.dataProvider = new HierarchicalData(root);
      }
      
      private function getChild(a:Array, name:String):Object
      {
        for each (var el:Object in a)
          if (el.name == name)
            return el;
        return null;
      }
      
      private function dateFunction(item:Object, column:AdvancedDataGridColumn):String
      {
        try {
          var value:int = item[column.dataField];
          return value == -1 ? '' : TimeUtils.timestampFormatter(value * 1000);
        } catch (e:Error) {}
        return '';
      }
      
      private function sizeFunction(item:Object, column:AdvancedDataGridColumn):String
      {
        try {
          var value:int = item[column.dataField];
          return value == -1 ? '' : Size.toHumanBytes(item[column.dataField]);
        } catch (e:Error) {}
        return '';
      }
      
      private function onRemovedFromStage():void
      {
        grid.dataProvider = null;
      }
    ]]>
  </fx:Script>
  
  <filesystem:FileSystemActionBar id="actionBar" selectedObject="{grid.selectedItem}" section="{section}"/>
  
  <!--mx:Tree id="tree" width="100%" height="100%" allowMultipleSelection="false" borderVisible="false"
           labelField="name" showRoot="true"/-->
  
  <mx:AdvancedDataGrid id="grid" width="100%" height="100%" sortableColumns="false">
    <mx:columns>
      <mx:AdvancedDataGridColumn dataField="name" width="400"/>
      <mx:AdvancedDataGridColumn dataField="date" labelFunction="dateFunction" width="160"/>
      <mx:AdvancedDataGridColumn dataField="size" labelFunction="sizeFunction" width="100"/>
      <!--mx:AdvancedDataGridColumn dataField="attr" width="100"/-->
    </mx:columns>
  </mx:AdvancedDataGrid>
  
</s:VGroup>