<?xml version="1.0" encoding="utf-8"?>
<s:VGroup xmlns:fx="http://ns.adobe.com/mxml/2009"
          xmlns:s="library://ns.adobe.com/flex/spark"
          xmlns:mx="library://ns.adobe.com/flex/mx"
          xmlns:configuration="it.ht.rcs.console.operations.view.configuration.*"
          xmlns:basic="it.ht.rcs.console.operations.view.configuration.basic.*"
          xmlns:advanced="it.ht.rcs.console.operations.view.configuration.advanced.*"
          width="100%" height="100%" addedToStage="onAddedToStage()"
          creationComplete="onCreationComplete()">

  <fx:Script>
    <![CDATA[
      import it.ht.rcs.console.agent.controller.AgentManager;
      import it.ht.rcs.console.agent.model.Agent;
      import it.ht.rcs.console.agent.model.Config;
      import it.ht.rcs.console.operations.view.OperationsSection;
      
      import mx.rpc.events.ResultEvent;
      
      [Bindable]
      public var section:OperationsSection;
      
      private var configAsConfig:Config;
      private var configAsObject:Object;
      
      private var fired:Boolean = false;
      private function onCreationComplete():void
      {
        fired = true;
        getConfig();
      }
      
      private function onAddedToStage():void
      {
        if (fired)
          getConfig();
      }
      
      private function getConfig():void
      {
        configAsConfig = section.stateManager.selectedConfig;
        
        if (configAsConfig == null) // Factory
        {
          var factory:Agent = section.stateManager.selectedFactory;
          AgentManager.instance.show(factory._id, function(e:ResultEvent):void {
            configAsConfig = (e.result as Agent).configs.getItemAt(0) as Config;
            displayConfig();
          });
        }
        else // An Agent's config
        {
          displayConfig();
        }
      }
      
      private function displayConfig():void
      {
        configAsObject = JSON.parse(configAsConfig.config);
        currentState = configAsObject.globals.advanced ? "advanced" : "basic";
        switch (currentState) {
          case "basic":
            basic.config = configAsObject;
            basic.displayConfig();
            break;
          case "advanced":
            advanced.config = configAsObject;
            advanced.displayConfig();
        }
      }
    ]]>
  </fx:Script>
  
  <s:states>
    <s:State name="blank"/>
    <s:State name="basic"/>
    <s:State name="advanced"/>
  </s:states>
  
  <configuration:ConfigurationActionBar section="{section}"/>
  
  <basic:BasicView id="basic" visible="false" includeInLayout="false"
                   visible.basic="true" includeInLayout.basic="true"/>
  
  <advanced:AdvancedView id="advanced" visible="false" includeInLayout="false"
                         visible.advanced="true" includeInLayout.advanced="true"/>

</s:VGroup>