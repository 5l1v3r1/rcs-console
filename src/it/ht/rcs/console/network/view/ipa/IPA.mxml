<?xml version="1.0" encoding="utf-8"?>
<s:VGroup xmlns:fx="http://ns.adobe.com/mxml/2009"
          xmlns:s="library://ns.adobe.com/flex/spark"
          xmlns:mx="library://ns.adobe.com/flex/mx"
          xmlns:ipa="it.ht.rcs.console.network.view.ipa.*"
          left="5" right="5" top="0" bottom="5" addedToStage="onAddedToStage()">
  
  
  <s:BorderContainer width="100%" height="100%" dropShadowVisible="true">
    
    <ipa:IPAList id="ipas" left="5" right="5" top="5" bottom="5" width="100%" borderVisible="false"
                 dataProvider="{_proxy_view}" keyDown="enter(event)"/>
    
    <s:Button right="33" bottom="1" width="32" height="20" label="-" click="deleteProxy()"
              enabled="{ipas.selectedItem != null}" styleName="AddRemove"
              toolTip="{R.get('PROXY_DELETE')}"/>
    <s:Button right="1" bottom="1" width="32" height="20" label="+" click="addProxy()"
              styleName="AddRemove" toolTip="{R.get('PROXY_ADD')}"/>

  </s:BorderContainer>
  
  <s:HGroup>
    <s:Button width="30" height="20" label="New" click="addRule()"
              enabled="{ipas.selectedItem != null}" skinClass="it.ht.rcs.console.skins.NewButton"
              toolTip="{R.get('RULE_ADD')}"/>
    <s:Button width="30" height="20" label="Edit" click="editRule()"
              enabled="{rulesGrid.selectedItem != null}"
              skinClass="it.ht.rcs.console.skins.EditButton" toolTip="{R.get('EDIT')}"/>
    <s:Button width="30" height="20" label="Delete" enabled="{rulesGrid.selectedItem != null}" click="deleteRule()"
              skinClass="it.ht.rcs.console.skins.DeleteButton" toolTip="{R.get('DELETE')}"/>
    <s:Spacer width="15"/>
    <s:Button width="30" height="20" label="Apply" enabled="{ipas.selectedItem != null}"
              skinClass="it.ht.rcs.console.skins.ApplyButton" toolTip="{R.get('APPLY_RULES')}"/>
  </s:HGroup>
  
  <ipa:RulesGrid id="rulesGrid" width="100%" height="100%" dataProvider="{ipas.selectedItem.rules}"/>
  
  
  <fx:Script>
    <![CDATA[
      import it.ht.rcs.console.network.controller.ProxyController;
      import it.ht.rcs.console.network.controller.ProxyManager;
      import it.ht.rcs.console.network.model.Proxy;
      import it.ht.rcs.console.network.model.ProxyRule;
      import it.ht.rcs.console.utils.AlertPopUp;
      
      import locale.R;
      
      import mx.collections.ListCollectionView;
      import mx.events.CloseEvent;
      import mx.managers.PopUpManager;
      
      [Bindable]
      private var _proxy_view:ListCollectionView;
      
      private function onAddedToStage():void
      {
        _proxy_view = ProxyManager.instance.getView();
      }
      
      private function addProxy():void
      {
        ProxyController.instance.addProxy(function onSuccess(proxy:it.ht.rcs.console.network.model.Proxy):void {
          ipas.selectedItem = proxy;
          createProxy(proxy);
        });
      }
      
      private function createProxy(proxy:it.ht.rcs.console.network.model.Proxy):void
      {
        var popup:CreateIPAForm = PopUpManager.createPopUp(this.parentDocument as DisplayObject, CreateIPAForm, true) as CreateIPAForm;
        popup.proxy = proxy;
        PopUpManager.centerPopUp(popup);
      }
      
      private function editProxy(proxy:it.ht.rcs.console.network.model.Proxy):void
      {
        var popup:EditIPAForm = PopUpManager.createPopUp(this.parentDocument as DisplayObject, EditIPAForm, true) as EditIPAForm;
        popup.proxy = proxy;
        PopUpManager.centerPopUp(popup);
      }
      
      protected function deleteProxy():void
      {
        AlertPopUp.show(R.get('CONFIRM_PROXY_DELETION') + ' ' + ipas.selectedItem.name + '?',
                        R.get('CONFIRM'),
                        AlertPopUp.YES | AlertPopUp.NO,
                        null,
                        function(e:CloseEvent):void {
                          if (e.detail == AlertPopUp.YES) 
                            ProxyController.instance.removeItem(ipas.selectedItem);
                        },
                        null, AlertPopUp.NO);
      }
      
      protected function enter(event:KeyboardEvent):void
      {
        if (event.keyCode == Keyboard.ENTER && ipas.selectedItem != null)
          editProxy(ipas.selectedItem);
      }
      
      private function addRule():void
      {
        var proxy:it.ht.rcs.console.network.model.Proxy = ipas.selectedItem;
        proxy.rulesManager.addRule(proxy._id, function onSuccess(rule:ProxyRule):void {
          rulesGrid.selectedItem = rule;
          createRule(rule);
        });
      }
      
      protected function createRule(rule:ProxyRule):void
      {
        var popup:RuleForm = PopUpManager.createPopUp(this.parentDocument as DisplayObject, RuleForm, true) as RuleForm;
        popup.rule = rule;
        popup.mode = 'create';
        PopUpManager.centerPopUp(popup);
      }
      
      protected function editRule():void
      {
        var popup:RuleForm = PopUpManager.createPopUp(this.parentDocument as DisplayObject, RuleForm, true) as RuleForm;
        popup.rule = rulesGrid.selectedItem as ProxyRule;
        PopUpManager.centerPopUp(popup);
      }
      
      protected function deleteRule():void
      {
        AlertPopUp.show(R.get('CONFIRM_PROXY_DELETION'),
          R.get('CONFIRM'),
          AlertPopUp.YES | AlertPopUp.NO,
          null,
          function(e:CloseEvent):void {
            if (e.detail == AlertPopUp.YES)
              rulesGrid.dataProvider.removeItemAt(rulesGrid.selectedIndex);
          },
          null, AlertPopUp.NO);
      }
      
    ]]>
  </fx:Script>

</s:VGroup>