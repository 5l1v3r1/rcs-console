<?xml version="1.0" encoding="utf-8"?>
<s:Panel xmlns:fx="http://ns.adobe.com/mxml/2009" 
         xmlns:s="library://ns.adobe.com/flex/spark" 
         xmlns:mx="library://ns.adobe.com/flex/mx"
         title="ALERTING" width="100%" height="100%" 
         xmlns:alerting="it.ht.rcs.console.monitor.*"
         addedToStage="added()"
         removedFromStage="removed()"
         creationComplete="init()">

  <fx:Script>
    <![CDATA[
      import it.ht.rcs.console.alert.controller.AlertManager;
      import it.ht.rcs.console.alert.model.Alert;
      import it.ht.rcs.console.alert.model.AlertLog;
      import it.ht.rcs.console.utils.TimeUtils;
      
      import mx.collections.ListCollectionView;
      import mx.collections.Sort;
      import mx.collections.SortField;
      import mx.managers.PopUpManager;
      
      [Bindable]
      private var _alert_view:ListCollectionView;
      
      private function init():void
      {
        /* default sorting: status */
        var sort:Sort = new Sort();
        sort.fields = [new SortField('_id', true, true, true)];
        
        _alert_view = AlertManager.instance.getView(sort);
      }
      
      private function added():void
      {
        /* start the auto refresh when the section is open */
        AlertManager.instance.start();
      }
      
      private function removed():void
      {
        /* stop the auto refresh when going away */
        AlertManager.instance.stop();
      }
      
      private function formatdate(item:Object, column:GridColumn):String
      {
        return TimeUtils.timestampFormatter(item[column.dataField] * 1000);
      }
      
      private function addAlert():void
      {
        AlertManager.instance.newAlert(function onSuccess(a:Alert):void {
          selectAlert(a);
          editAlert(a);
        });
      }
      
      private function selectAlert(a:Alert):void
      {
        alertlist.selectedItem = a;
      }
      
      private function editAlert(a:Alert):void
      {
        var ea:AlertEdit = PopUpManager.createPopUp(root, AlertEdit, true) as AlertEdit;
        ea.alert = a;
        PopUpManager.centerPopUp(ea);
      }
      
      private function deleteAlert(a:Alert):void
      {
        if (a == null)
          return;
        
        AlertManager.instance.removeItem(a);
      }
      
      private function deleteLog(l:AlertLog):void
      {
        if (l == null) {
          /* if null is passed, delete all the logs */
          (alertlist.selectedItem as Alert).logs.removeAll();
        } else {
          var i:int = (alertlist.selectedItem as Alert).logs.getItemIndex(alertloglist.selectedItem);
          (alertlist.selectedItem as Alert).logs.removeItemAt(i);
        }
      }
      
    ]]>
  </fx:Script>
  
  <fx:Metadata>
    [ResourceBundle("localized_main")] 
  </fx:Metadata>
  
  <s:VGroup width="100%" height="100%">
    
    <!-- ALERT QUERIES -->
    <s:SkinnableContainer width="100%" height="100%">
      
      <!-- button bar (transparent container) -->  
      <s:BorderContainer borderVisible="false" top="5" left="5" right="5" height="20" backgroundAlpha="0.0">
        <s:Button x="0" y="0" label="N" width="30" height="20" click="addAlert()" toolTip="{resourceManager.getString('localized_main', 'NEW')}" skinClass="it.ht.rcs.console.skins.NewButton"/>
        <s:Button x="40" y="0" label="E" width="30" height="20" click="editAlert(alertlist.selectedItem as Alert)" enabled="{alertlist.selectedItem != null}" toolTip="{resourceManager.getString('localized_main', 'EDIT')}" skinClass="it.ht.rcs.console.skins.EditButton"/>
        <s:Button x="80" y="0" label="D" width="30" height="20" click="deleteAlert(alertlist.selectedItem as Alert)" enabled="{alertlist.selectedItem != null}" toolTip="{resourceManager.getString('localized_main', 'DELETE')}" skinClass="it.ht.rcs.console.skins.DeleteButton"/>
      </s:BorderContainer>
      
      <!-- alert queries -->
      <s:DataGrid id="alertlist" left="5" right="5" top="30" height="100%" dataProvider="{_alert_view}" doubleClickEnabled="true" doubleClick="editAlert(alertlist.selectedItem as Alert)">
        <s:columns>
          <s:ArrayList>
            <s:GridColumn dataField="logs.length" headerText="Logs" width="45">
              <s:itemRenderer>
                <fx:Component>
                  <s:GridItemRenderer>
                    <s:SkinnableContainer width="100%">
                      <s:Label width="100%" text="{data.logs.length}" top="9" right="5" left="5" textAlign="right"/>                                          
                    </s:SkinnableContainer>
                  </s:GridItemRenderer>
                </fx:Component>
              </s:itemRenderer>
            </s:GridColumn>
            <s:GridColumn dataField="enabled" headerText="En" width="30" resizable="false">
              <s:itemRenderer>
                <fx:Component>
                  <s:GridItemRenderer>
                    <s:SkinnableContainer>
                      <s:CheckBox selected="@{data.enabled}" top="4" right="5" left="8"/>                                          
                    </s:SkinnableContainer>
                  </s:GridItemRenderer>
                </fx:Component>
              </s:itemRenderer>
            </s:GridColumn>
            <s:GridColumn dataField="type" headerText="{resourceManager.getString('localized_main', 'TYPE')}" width="50"/>
            <s:GridColumn dataField="path" headerText="Operation" itemRenderer="it.ht.rcs.console.alerting.view.OperationRenderer" />
            <s:GridColumn dataField="path" headerText="Target" itemRenderer="it.ht.rcs.console.alerting.view.TargetRenderer"/>
            <s:GridColumn dataField="path" headerText="Backdoor" itemRenderer="it.ht.rcs.console.alerting.view.BackdoorRenderer" />
            <s:GridColumn dataField="action" headerText="{resourceManager.getString('localized_main', 'ACTION')}" width="80"/>
            <s:GridColumn dataField="evidence" headerText="Evidence" width="80"/>
            <s:GridColumn dataField="tag" headerText="{resourceManager.getString('localized_main', 'TAG')}" width="35" itemRenderer="it.ht.rcs.console.alerting.view.TagRenderer"/>
            <s:GridColumn dataField="keywords" headerText="{resourceManager.getString('localized_main', 'KEYWORD')}"></s:GridColumn>
          </s:ArrayList>
        </s:columns>
      </s:DataGrid>
      
    </s:SkinnableContainer>

    <!-- ALERT LOGS -->
    <s:SkinnableContainer width="100%" height="100%">
      
      <!-- button bar (transparent container) -->  
      <s:BorderContainer borderVisible="false" top="5" left="5" right="5" height="20" backgroundAlpha="0.0">
        <s:Button x="0" y="0" label="D" width="30" height="20" click="deleteLog(alertloglist.selectedItem as AlertLog)" enabled="{alertloglist.selectedItem != null}" toolTip="{resourceManager.getString('localized_main', 'DELETE')}" skinClass="it.ht.rcs.console.skins.DeleteButton"/>
        <s:Button x="40" y="0" label="A" width="30" height="20" click="deleteLog(null)" toolTip="{resourceManager.getString('localized_main', 'DELETE_ALL')}" skinClass="it.ht.rcs.console.skins.DeleteButton"/>
      </s:BorderContainer>
      
      <s:DataGrid id="alertloglist" left="5" right="5" top="30" bottom="5" requestedRowCount="4" dataProvider="{(alertlist.selectedItem as Alert).logs}">
        <s:columns>
          <s:ArrayList>
            <s:GridColumn dataField="time" headerText="{resourceManager.getString('localized_main', 'TIME')}" width="130" labelFunction="formatdate" resizable="false"/>
            <s:GridColumn dataField="path" headerText="Backdoor" width="250"/>
            <s:GridColumn dataField="evidence" headerText="Evidence"></s:GridColumn>
          </s:ArrayList>
        </s:columns>
      </s:DataGrid>
      
    </s:SkinnableContainer>
  </s:VGroup>
</s:Panel>
