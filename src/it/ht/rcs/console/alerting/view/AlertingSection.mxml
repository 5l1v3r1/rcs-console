<?xml version="1.0" encoding="utf-8"?>
<main:Section xmlns:fx="http://ns.adobe.com/mxml/2009"
              xmlns:s="library://ns.adobe.com/flex/spark"
              xmlns:mx="library://ns.adobe.com/flex/mx"
              xmlns:main="it.ht.rcs.console.main.*"
              xmlns:view="it.ht.rcs.console.alerting.view.*"
              addedToStage="onAddedToStage()" creationComplete="init()"
              removedFromStage="onRemovedFromStage()">
  
  
  <main:layout>
    <s:VerticalLayout paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5"/>
  </main:layout>
  
  
  <fx:Script>
    <![CDATA[
      import com.hurlant.crypto.symmetric.NullPad;
      
      import it.ht.rcs.console.alert.controller.AlertManager;
      import it.ht.rcs.console.alert.model.Alert;
      
      import mx.collections.ArrayCollection;
      import mx.collections.ArrayList;
      import mx.collections.ListCollectionView;
      
      import spark.collections.Sort;
      import spark.collections.SortField;
      import spark.events.GridSelectionEvent;
      
      [Bindable]
      private var view:ListCollectionView;
      
      private function init():void
      {
        var defaultSort:Sort = new Sort();
        defaultSort.fields = [new SortField('_id', false, false)];
        view = AlertManager.instance.getView(defaultSort, searchFilterFunction);
      }
      
      private function onAddedToStage():void
      {
        AlertManager.instance.listenRefresh();
        AlertManager.instance.startAutorefresh();
      }
      
      private function onRemovedFromStage():void
      {
        AlertManager.instance.unlistenRefresh();
        AlertManager.instance.stopAutorefresh();
      }
      
      private function searchFilterFunction(item:Object):Boolean
      {
        if (item.keywords == null && alertBar.searchInput.text.length > 0)
          return false;
        
        try {
          return item.keywords.toLowerCase().indexOf(alertBar.searchInput.text.toLowerCase()) != -1;
        } catch (e:Error) {}
        
        return true;
      }
      
      private function alertsSelectionChange(event:GridSelectionEvent):void
      {
        alertBar.selectedObject = alerts.selectedItem ? alerts.selectedItem : null;
        logs.dataProvider = alerts.selectedItem ? alerts.selectedItem.logs : null;
        logs.selectedItem = null;
        logBar.selectedObject = null;
        logBar.view = logs.dataProvider as ArrayCollection;
      }
      
      private function logsSelectionChange(event:GridSelectionEvent):void
      {
        logBar.selectedObject = logs.selectedItem ? logs.selectedItem : null;
      }
    ]]>
  </fx:Script>
  

  <view:AlertingActionBar id="alertBar" view="{view}" section="{this}"/>
  
  <view:AlertingTable id="alerts" dataProvider="{view}" selectionChange="alertsSelectionChange(event)"/>
  
  <view:LogsActionBar id="logBar" section="{this}"/>
 
  <view:LogsTable id="logs" selectionChange="logsSelectionChange(event)"/>


</main:Section>